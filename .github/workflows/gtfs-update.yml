# .github/workflows/gtfs-update.yml
name: Actualizaci칩n GTFS Renfe

# Programaci칩n: Ejecutar a las 02:00 AM (0 2) cada dos d칤as (*/2)
on:
  schedule:
    # Esto se aproxima a cada 48 horas.
    - cron: '0 2 */2 * *'
  # Permite ejecutarlo manualmente desde la pesta침a "Actions"
  workflow_dispatch:

jobs:
  update-gtfs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del c칩digo
        uses: actions/checkout@v4
        # Necesario para que la Action pueda hacer commit
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Instalar dependencias (requests)
        run: pip install requests

      - name: Descargar, extraer y limpiar GTFS (Python) 游빞
        # Este script descarga el ZIP y extrae S칍LO los archivos necesarios a la carpeta 'gtfs/'.
        run: |
          python - <<EOF
          import requests
          import zipfile
          import io
          import os

          ZIP_URL = "https://ssl.renfe.com/ftransit/Fichero_CER_FOMENTO/fomento_transit.zip"
          TARGET_DIR = "gtfs" # Directorio donde se guardar치n los archivos
          # Archivos que S칈 necesitamos y mantendremos
          FILES_TO_EXTRACT = ['routes.txt', 'trips.txt']
          # Archivo que queremos eliminar para ahorrar espacio
          FILE_TO_DELETE = 'stop_times.txt' 

          print("Descargando GTFS ZIP...")
          
          # Crear el directorio 'gtfs' si no existe
          if not os.path.exists(TARGET_DIR):
              os.makedirs(TARGET_DIR)
          
          response = requests.get(ZIP_URL, timeout=60)
          response.raise_for_status()

          z = zipfile.ZipFile(io.BytesIO(response.content))
          
          # 1. Extraer S칍LO los archivos que necesitamos a la carpeta TARGET_DIR
          for filename in z.namelist():
              # Ignorar los archivos que puedan estar en subdirectorios dentro del ZIP, nos quedamos solo con el nombre
              base_filename = os.path.basename(filename) 
              
              if base_filename in FILES_TO_EXTRACT:
                  # Definir la ruta de destino dentro de la carpeta 'gtfs'
                  target_path = os.path.join(TARGET_DIR, base_filename)
                  
                  with z.open(filename) as source, open(target_path, "wb") as target:
                      target.write(source.read())
                      print(f"Extra칤do y mantenido: {target_path}")
              else:
                  # Ignoramos otros archivos como calendar.txt, etc.
                  print(f"Ignorado: {filename}")
                  
          # 2. Borrar expl칤citamente el archivo que NO queremos si ya exist칤a en la carpeta GTFS
          if os.path.exists(os.path.join(TARGET_DIR, FILE_TO_DELETE)):
              os.remove(os.path.join(TARGET_DIR, FILE_TO_DELETE))
              print(f"Eliminado archivo pesado: {FILE_TO_DELETE}")
              
          EOF
          
      - name: Configurar Git para el commit
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'

      - name: Verificar cambios y hacer commit
        id: commit
        run: |
          # A침adir S칍LO los archivos dentro de la carpeta GTFS
          git add gtfs/routes.txt gtfs/trips.txt
          
          # Verificar si hay algo que commitear
          if git diff --staged --quiet; then
            echo "::set-output name=commit_needed::false"
            echo "No hay cambios en GTFS. Terminando."
          else
            git commit -m "游뱄 Auto-Actualizaci칩n GTFS Renfe [skip ci]"
            echo "::set-output name=commit_needed::true"
          fi
          
      - name: Push (subir) los cambios si los hay
        if: steps.commit.outputs.commit_needed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
